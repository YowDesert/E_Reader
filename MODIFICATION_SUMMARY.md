# E_Reader 文字模式頁面保持功能修改摘要

## 修改內容

### 1. StateManager.java 修改
- 新增了 `currentImagePageIndex` 和 `currentTextPageIndex` 來分別追蹤圖片模式和文字模式下的當前頁面
- 新增了相關的 getter/setter 方法
- 新增了 `getCurrentPageIndex()` 和 `setCurrentPageIndex()` 方法來統一管理當前模式下的頁面索引

### 2. MainController.java 修改
- 修改了 `toggleTextMode()` 方法，在切換模式前會先保存當前頁面索引
- 修改了 `switchToTextMode()` 和 `switchToImageMode()` 方法，支援跳轉到指定頁面
- 修改了所有導航方法（`goToFirstPage()`, `goToPreviousPage()`, `goToNextPage()`, `goToLastPage()`, `goToPage()`），確保頁面切換時同步更新 StateManager 中的頁面索引
- 修改了文件載入相關方法，確保初始化時正確設置頁面索引

## 功能說明

### 原始問題
- 用戶在第 N 頁按下文字模式切換按鈕時，會跳回第一頁
- 用戶希望切換模式時保持在當前頁面

### 解決方案
1. **頁面狀態分離**: 為圖片模式和文字模式分別維護頁面索引
2. **模式切換保持位置**: 在切換模式前保存當前頁面，切換後跳轉到相同頁面
3. **頁面邊界檢查**: 確保跳轉的頁面不會超出文檔總頁數範圍
4. **用戶提示**: 切換模式時顯示保持頁面的通知

### 使用體驗改進
- 用戶在任何頁面切換到文字模式都會保持在相同頁面（或最接近的合法頁面）
- 從文字模式切換回圖片模式也會保持在相應頁面
- 提供視覺反饋，告知用戶切換後的頁面位置

### 邊界處理
- 如果目標頁面超出文檔範圍，會自動調整到合法範圍內
- 使用 `Math.min()` 和 `Math.max()` 確保頁面索引在有效範圍內

## 測試建議

1. **基本切換測試**:
   - 開啟一個多頁 PDF 或圖片資料夾
   - 瀏覽到中間某頁（如第 5 頁）
   - 切換到文字模式，確認保持在第 5 頁
   - 切換回圖片模式，確認仍在第 5 頁

2. **邊界測試**:
   - 在最後一頁切換模式
   - 在第一頁切換模式
   - 測試文檔頁數不匹配的情況（如圖片 10 頁，文字提取只有 8 頁）

3. **多次切換測試**:
   - 在不同頁面多次切換文字模式和圖片模式
   - 確認每次切換都能正確保持頁面位置
   - 測試在文字模式下瀏覽到不同頁面後切換回圖片模式

4. **異常情況測試**:
   - 測試文字提取失敗時的處理
   - 測試空文檔或無內容頁面的處理
   - 測試記憶體不足或載入超時的情況

## 程式碼品質改進

### 職責分離
- StateManager 專責管理應用狀態
- MainController 專責 UI 邏輯和用戶交互
- 頁面索引管理集中化

### 錯誤處理
- 添加了頁面範圍檢查
- 保持原有的錯誤處理機制
- 增加了用戶友好的通知訊息

### 向後兼容性
- 保持原有 API 不變
- 新增的方法都有適當的默認行為
- 不影響現有功能

## 注意事項

1. **文字提取時間**: 大型文檔的文字提取可能需要時間，用戶需要等待
2. **記憶體使用**: 同時保存圖片和文字內容會增加記憶體使用
3. **頁面對應**: 圖片頁面和文字頁面可能不是一對一對應

## 未來改進建議

1. **快取機制**: 實作文字內容快取，避免重複提取
2. **背景預載**: 在載入圖片時背景進行文字提取
3. **頁面映射**: 建立圖片頁面和文字頁面的精確映射關係
4. **進度指示**: 提供更詳細的文字提取進度資訊

## 使用方式

編譯並運行修改後的程式：

```bash
# 在專案根目錄下
mvn clean compile
mvn javafx:run
```

或者使用 IDE（如 IntelliJ IDEA 或 Eclipse）直接運行 `Main.java`。

## 驗證步驟

1. 開啟一個 PDF 檔案或圖片資料夾
2. 瀏覽到任意頁面（非第一頁）
3. 點擊「文字模式」按鈕
4. 等待文字提取完成
5. 確認顯示的是相同頁面的文字內容
6. 點擊「圖片模式」按鈕
7. 確認回到相同頁面的圖片顯示

預期結果：在整個切換過程中，頁面位置應該保持不變（或在合理範圍內）。