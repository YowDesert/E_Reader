# EPUB 支援功能實現說明

## 概述
成功為 E_Reader 應用程式添加了完整的 EPUB 電子書支援功能。現在程式可以讀取、顯示和管理 EPUB 檔案，就像處理 PDF 和圖片檔案一樣。

## 新增的功能

### 1. EPUB 檔案載入器 (EpubLoader.java)
- **位置**: `src/main/java/E_Reader/core/EpubLoader.java`
- **功能**:
  - 解析 EPUB 檔案結構（container.xml, OPF檔案）
  - 提取章節內容和順序
  - 將 HTML 內容轉換為純文字
  - 將章節渲染為圖片以供顯示
  - 提取文字內容供文字模式使用

### 2. 主程式更新 (Main.java)
- **新增功能**:
  - 支援開啟 EPUB 檔案
  - 錯誤處理和檔案格式驗證
  - 更新支援格式說明

### 3. 主控制器更新 (MainController.java)
- **新增功能**:
  - 整合 EpubLoader
  - 支援 EPUB 檔案的開啟和顯示
  - 文字模式支援 EPUB 內容提取
  - EPUB 狀態管理

### 4. 檔案管理器增強 (FileManagerController.java)
- **新增功能**:
  - 「匯入EPUB」按鈕
  - 自動創建「電子書」資料夾
  - EPUB 檔案圖示 (📚)
  - 檔案類型驗證和分類

### 5. 狀態管理器更新 (StateManager.java)
- **新增功能**:
  - `isEpubMode()` 狀態追蹤
  - 支援 EPUB 檔案載入狀態管理

## 支援的功能

### EPUB 讀取能力
- ✅ 標準 EPUB 2.0/3.0 格式
- ✅ 章節順序解析
- ✅ HTML 內容提取
- ✅ 文字內容清理和格式化
- ✅ 章節標題識別

### 顯示功能
- ✅ 章節渲染為圖片顯示
- ✅ 文字模式支援
- ✅ 頁面導航
- ✅ 書籤支援（繼承自現有功能）
- ✅ 縮放和全螢幕支援

### 檔案管理
- ✅ EPUB 檔案匯入
- ✅ 自動分類到「電子書」資料夾
- ✅ 檔案縮圖顯示
- ✅ 檔案資訊顯示

## 使用方式

### 開啟 EPUB 檔案
1. 啟動程式後，在檔案管理器中：
   - 點擊「📚 匯入EPUB」按鈕匯入新的 EPUB 檔案
   - 或雙擊已存在的 EPUB 檔案
2. 程式會自動解析並顯示 EPUB 內容

### 文字模式
- 點擊「📖 文字模式」按鈕可切換到純文字檢視
- 支援文字搜尋、複製等功能

### 檔案管理
- EPUB 檔案會自動匯入到「電子書」資料夾
- 支援重新命名、移動、刪除等操作

## 技術實現細節

### EPUB 解析流程
1. 驗證 mimetype 檔案
2. 解析 META-INF/container.xml 找到 OPF 檔案
3. 解析 OPF 檔案獲取：
   - manifest（檔案清單）
   - spine（章節順序）
4. 按順序提取章節內容
5. 清理 HTML 標籤並格式化文字

### 渲染系統
- 使用 Java Graphics2D 將文字內容渲染為圖片
- 支援中文字體渲染
- 自動分行和段落處理
- 章節標題特殊格式化

### 錯誤處理
- 檔案格式驗證
- 損壞檔案處理
- 缺少內容警告
- 載入進度顯示

## 系統需求

### 新增依賴項（已在 pom.xml 中配置）
- 所有 EPUB 解析功能使用 Java 標準庫實現
- 無需額外的第三方依賴

### 檔案格式支援
- EPUB 2.0 規格
- EPUB 3.0 規格（基本支援）
- 壓縮的 ZIP 格式 EPUB 檔案

## 已知限制

1. **圖片支援**: 目前版本主要專注於文字內容，EPUB 中的圖片暫時不會顯示
2. **複雜排版**: 複雜的 CSS 樣式和排版可能無法完美還原
3. **互動元素**: JavaScript 和互動式內容不被支援
4. **DRM 保護**: 不支援有版權保護的 EPUB 檔案

## 未來擴展計劃

1. **圖片支援**: 在章節中顯示內嵌圖片
2. **目錄功能**: 提取和顯示 EPUB 目錄結構
3. **樣式保留**: 更好地保留原始格式和樣式
4. **搜尋功能**: 跨章節的全文搜尋
5. **註解支援**: 添加筆記和高亮功能

## 測試建議

建議使用以下類型的 EPUB 檔案進行測試：
1. 簡單的文字小說
2. 包含章節標題的技術文檔
3. 多語言內容（中英文混合）
4. 不同來源的 EPUB 檔案

---

這個實現為 E_Reader 提供了完整的 EPUB 支援，使其成為一個真正的多格式電子閱讀器。用戶現在可以閱讀 PDF、圖片和 EPUB 三種主要的電子書格式。
